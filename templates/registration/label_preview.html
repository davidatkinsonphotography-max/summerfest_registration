{% extends 'base.html' %}

{% block title %}Label Preview - Summerfest{% endblock %}

{% block content %}
<div class="container py-4">
  <h2><i class="bi bi-tags"></i> Printable Label Preview</h2>
  <p class="text-muted">Configure label settings for Brother QL-700 with DK-22225 labels (38mm height). Icons show black for "Yes" and 20% grey for "No".</p>

  <!-- Label Settings Form -->
  <div class="row mb-4">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h5><i class="bi bi-gear"></i> Label Settings</h5>
        </div>
        <div class="card-body">
          <form id="label-settings-form" method="post" action="{% url 'save_label_settings' %}">
            {% csrf_token %}
            <div class="row">
              <div class="col-md-3">
                <label for="label-width" class="form-label">Width (mm)</label>
                <input type="number" id="label-width" name="label_width" class="form-control" 
                       value="{{ label_settings.label_width }}" min="20" max="100" step="1">
              </div>
              <div class="col-md-3">
                <label for="label-height" class="form-label">Height (mm)</label>
                <input type="number" id="label-height" name="label_height" class="form-control" 
                       value="{{ label_settings.label_height }}" min="15" max="60" step="1">
              </div>
              <div class="col-md-3">
                <label for="font-scale" class="form-label">Font Scale</label>
                <input type="number" id="font-scale" name="font_scale" class="form-control" 
                       value="{{ label_settings.font_scale }}" min="0.5" max="2.0" step="0.1">
              </div>
              <div class="col-md-3">
                <label for="printer-name" class="form-label">Printer Name</label>
                <input type="text" id="printer-name" name="printer_name" class="form-control" 
                       value="{{ label_settings.printer_name }}" placeholder="e.g., Brother QL-700">
              </div>
            </div>
            
            <div class="row mt-3">
              <div class="col-md-6">
                <div class="form-check">
                  <input type="checkbox" id="auto-print" name="auto_print_on_checkin" class="form-check-input" 
                         {% if label_settings.auto_print_on_checkin %}checked{% endif %}>
                  <label for="auto-print" class="form-check-label">
                    Auto-print labels on check-in
                  </label>
                </div>
              </div>
            </div>

            <div class="row mt-3">
              <div class="col-12">
                <h6>Icon Visibility:</h6>
                <div class="form-check form-check-inline">
                  <input type="checkbox" id="show-medical" name="show_medical_icon" class="form-check-input" 
                         {% if label_settings.show_medical_icon %}checked{% endif %}>
                  <label for="show-medical" class="form-check-label">Medical</label>
                </div>
                <div class="form-check form-check-inline">
                  <input type="checkbox" id="show-dietary" name="show_dietary_icon" class="form-check-input" 
                         {% if label_settings.show_dietary_icon %}checked{% endif %}>
                  <label for="show-dietary" class="form-check-label">Dietary</label>
                </div>
                <div class="form-check form-check-inline">
                  <input type="checkbox" id="show-photo" name="show_photo_icon" class="form-check-input" 
                         {% if label_settings.show_photo_icon %}checked{% endif %}>
                  <label for="show-photo" class="form-check-label">Photo</label>
                </div>
              </div>
            </div>
            
            <div class="mt-3">
              <button type="button" class="btn btn-primary btn-sm" onclick="updateLabelSizes()">
                <i class="bi bi-arrow-clockwise"></i> Update Preview
              </button>
              <button type="submit" class="btn btn-success btn-sm ms-2">
                <i class="bi bi-save"></i> Save Settings
              </button>
              <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="resetToDefault()">
                <i class="bi bi-arrow-counterclockwise"></i> Reset to Default
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h5><i class="bi bi-info-circle"></i> Current Settings</h5>
        </div>
        <div class="card-body">
          <p class="mb-1"><strong>Label Size:</strong> <span id="current-size">{{ label_settings.label_width }}mm Ã— {{ label_settings.label_height }}mm</span></p>
          <p class="mb-1"><strong>Font Scale:</strong> <span id="font-scale-display">{{ label_settings.font_scale }}x</span></p>
          <p class="mb-1"><strong>Auto-print:</strong> <span id="auto-print-status">{% if label_settings.auto_print_on_checkin %}ON{% else %}OFF{% endif %}</span></p>
          <p class="mb-0"><strong>Printer:</strong> <span id="printer-status">{{ label_settings.printer_name|default:"Not set" }}</span></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Label Preview -->
  <div class="row mb-4">
    <div class="col-12">
      <h4><i class="bi bi-eye"></i> Label Preview (All Children)</h4>
      <p class="text-muted">Showing {{ samples|length }} children. Icons are right-aligned with color coding: black = Yes, 20% grey = No</p>
    </div>
  </div>

  <div class="d-flex flex-wrap gap-3" id="label-container">
    {% for s in samples %}
    <div class="label-card" data-width="{{ label_settings.label_width }}" data-height="{{ label_settings.label_height }}">
      <div class="label-grid">
        <div class="col-left">
          <div class="first-name">{{ s.first_name }}</div>
          <div class="surname">{{ s.last_name }}</div>
          <div class="class-name">{{ s.class_display }}</div>
        </div>
        <div class="col-icons">
          {% if label_settings.show_medical_icon %}
          <div class="icon {% if s.medical %}yes{% else %}no{% endif %}" title="Medical needs">
            <!-- Medical cross -->
            <svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true">
              <rect x="9" y="3" width="6" height="18" rx="2" fill="currentColor"></rect>
              <rect x="3" y="9" width="18" height="6" rx="2" fill="currentColor"></rect>
            </svg>
          </div>
          {% endif %}
          {% if label_settings.show_dietary_icon %}
          <div class="icon {% if s.dietary %}yes{% else %}no{% endif %}" title="Dietary needs">
            <!-- Plate with utensils -->
            <svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true">
              <circle cx="12" cy="12" r="7" fill="currentColor"></circle>
              <rect x="3" y="3" width="2" height="18" fill="currentColor"></rect>
              <rect x="19" y="3" width="2" height="18" fill="currentColor"></rect>
            </svg>
          </div>
          {% endif %}
          {% if label_settings.show_photo_icon %}
          <div class="icon {% if s.photo %}yes{% else %}no{% endif %}" title="Photo consent">
            <!-- Camera -->
            <svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true">
              <rect x="3" y="7" width="18" height="12" rx="2" fill="currentColor"></rect>
              <circle cx="12" cy="13" r="4" fill="white"></circle>
              <circle cx="12" cy="13" r="2" fill="currentColor"></circle>
            </svg>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <div class="mt-3">
    <button class="btn btn-outline-primary btn-sm" onclick="window.print()">
      <i class="bi bi-printer"></i> Print Preview
    </button>
    <a href="{% url 'site_map' %}" class="btn btn-outline-secondary btn-sm ms-2">
      <i class="bi bi-arrow-left"></i> Back to Site Map
    </a>
  </div>
</div>

<style>
/* Dynamic label sizing */
.label-card {
  border: 1px solid #000;
  padding: 0.2cm; /* ~2mm border equivalent */
  box-sizing: border-box;
  transition: all 0.3s ease;
  margin-bottom: 0.5cm;
}

/* 2 columns: text | icons (right-aligned) */
.label-grid {
  display: grid;
  grid-template-columns: 1fr auto;
  column-gap: 0.2cm; /* 2mm gap */
  height: 100%;
  align-items: center;
}

.col-left { 
  display: flex; 
  flex-direction: column; 
  justify-content: center; 
  min-width: 0; /* Allow text to shrink */
}

.first-name { 
  font-weight: 700; 
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.surname { 
  color: #aaaaaa; 
  margin: 1mm 0; 
  text-transform: uppercase; 
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.class-name { 
  font-weight: 700; 
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.col-icons { 
  display: flex; 
  flex-direction: column; 
  align-items: center; 
  gap: 2mm; 
  justify-content: center;
  min-width: 24px; /* Ensure icons have space */
}

.icon { 
  color: #000; /* Black for "Yes" */
  display: flex;
  align-items: center;
  justify-content: center;
}

.icon.no { 
  color: #dfdfdf; /* 20% grey for "No" - still visible but light */
}

.icon svg {
  width: 36px;
  height: 36px;
  flex-shrink: 0;
}

@media print {
  body { 
    -webkit-print-color-adjust: exact; 
    print-color-adjust: exact; 
  }
  .btn, .card, .container > .row:first-child, .container > .row:nth-child(2) { 
    display: none; 
  }
  .label-card {
    break-inside: avoid;
    margin-bottom: 0.2cm;
  }
  #label-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(50mm, 1fr));
    gap: 0.2cm;
  }
}
</style>

<script>
function updateLabelSizes() {
  const width = parseInt(document.getElementById('label-width').value);
  const height = parseInt(document.getElementById('label-height').value);
  const fontScale = parseFloat(document.getElementById('font-scale').value);
  
  // Update current size display
  document.getElementById('current-size').textContent = `${width}mm Ã— ${height}mm`;
  
  // Update font scale display
  document.getElementById('font-scale-display').textContent = `${fontScale.toFixed(1)}x`;
  
  // Update all label cards
  const labelCards = document.querySelectorAll('.label-card');
  labelCards.forEach(card => {
    // Set physical dimensions
    card.style.width = `${width}mm`;
    card.style.height = `${height}mm`;
    
    // Update font sizes based on scale
    const firstName = card.querySelector('.first-name');
    const surname = card.querySelector('.surname');
    const className = card.querySelector('.class-name');
    
    if (firstName) {
      firstName.style.fontSize = `${8 * fontScale}mm`;
      firstName.style.lineHeight = `${8 * fontScale}mm`;
    }
    if (surname) {
      surname.style.fontSize = `${3 * fontScale}mm`;
      surname.style.lineHeight = `${3 * fontScale}mm`;
    }
    if (className) {
      className.style.fontSize = `${7 * fontScale}mm`;
      className.style.lineHeight = `${7 * fontScale}mm`;
    }
    
    // Icons stay the same size regardless of font scale for better visibility
    // But we can adjust the gap between icons if needed
    const iconContainer = card.querySelector('.col-icons');
    if (iconContainer) {
      iconContainer.style.gap = `${2 * fontScale}mm`;
    }
  });
}

function resetToDefault() {
  document.getElementById('label-width').value = 80;
  document.getElementById('label-height').value = 38;
  document.getElementById('font-scale').value = 1.0;
  updateLabelSizes();
}

// Auto-update preview when form values change
document.getElementById('label-width').addEventListener('input', updateLabelSizes);
document.getElementById('label-height').addEventListener('input', updateLabelSizes);
document.getElementById('font-scale').addEventListener('input', updateLabelSizes);

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  updateLabelSizes();
});

// Handle form submission
document.getElementById('label-settings-form').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  
  fetch('{% url "save_label_settings" %}', {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update status indicators
      const autoPrintCheckbox = document.getElementById('auto-print');
      const printerName = document.getElementById('printer-name');
      
      document.getElementById('auto-print-status').textContent = autoPrintCheckbox.checked ? 'ON' : 'OFF';
      document.getElementById('printer-status').textContent = printerName.value || 'Not set';
      
      // Show success message
      alert('Settings saved successfully!');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error saving settings. Please try again.');
  });
});
</script>
{% endblock %}
