{% extends 'base.html' %}
{% load static %}

{% block title %}Teacher Dashboard - Summerfest{% endblock %}

{% block extra_css %}
<style>
/* Tabs styling */
.tabs-container {
    display: flex;
    justify-content: flex-end;
    margin-bottom: -1px;
    gap: 5px;
}

.tab-button {
    padding: 8px 16px;
    border: 1px solid #dee2e6;
    border-bottom: none;
    background: #f8f9fa;
    cursor: pointer;
    border-radius: 5px 5px 0 0;
    font-size: 14px;
    transition: all 0.2s;
}

.tab-button:hover {
    background: #e9ecef;
}

.tab-button.active {
    background: white;
    font-weight: bold;
    border-bottom: 2px solid white;
    margin-bottom: -2px;
}

/* Simplified table wrapper */
.table-wrapper {
    position: relative;
    overflow-x: auto;
    overflow-y: hidden;
    border: 1px solid #dee2e6;
}

.tab-content {
    display: none;
    animation: slideIn 0.3s ease-out;
}

.tab-content.active {
    display: block;
}

.tab-content.slide-out-left {
    animation: slideOutLeft 0.3s ease-out;
}

.tab-content.slide-out-right {
    animation: slideOutRight 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes slideOutLeft {
    from {
        opacity: 1;
        transform: translateX(0);
    }
    to {
        opacity: 0;
        transform: translateX(-20px);
    }
}

@keyframes slideOutRight {
    from {
        opacity: 1;
        transform: translateX(0);
    }
    to {
        opacity: 0;
        transform: translateX(20px);
    }
}

.tab-content table {
    margin-bottom: 0;
    width: 100%;
    table-layout: auto;
    border-collapse: collapse;
}

.tab-content td,
.tab-content th {
    padding: 8px 6px;
    border: 1px solid #dee2e6;
    vertical-align: top;
    box-sizing: border-box;
}

/* Fixed width columns for consistency */
.tab-content th:first-child,
.tab-content td:first-child {
    width: 160px;
    min-width: 160px;
    max-width: 160px;
}

.tab-content th:nth-child(2),
.tab-content td:nth-child(2) {
    width: 100px;
    min-width: 100px;
    max-width: 100px;
}

/* Unified header cell styling */
.tab-content th {
    height: 54px;
    line-height: 1.2;
    white-space: normal;
    word-break: break-word;
    vertical-align: middle;
    padding: 6px 8px;
    border-bottom: 1px solid #dee2e6;
    border-right: 1px solid #dee2e6;
    background-color: #f8f9fa;
    font-weight: 600;
    text-align: left;
    box-sizing: border-box;
}

/* Note box container */
.note-box-container {
    position: relative;
    height: 90px;
    padding: 8px;
    margin-bottom: 20px;
}

.note-box {
    width: 100%;
    height: 100%;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 6px;
    resize: none;
    font-size: 12px;
    transition: all 0.2s;
}

.note-box:focus {
    border-color: #0d6efd;
    outline: none;
    box-shadow: 0 0 0 0.2rem rgba(13,110,253,0.25);
}

.note-box.has-content {
    border-color: #0d6efd;
}

/* Note indicators container */
.note-indicator {
    position: absolute;
    right: 12px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    align-items: center;
}

/* Eye icon at top */
.eye-icon {
    width: 20px;
    height: 20px;
    background: #6c757d;
    border-radius: 50%;
    display: none;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: white;
    font-size: 12px;
}

.eye-icon:hover {
    background: #5a6268;
}

/* Save tick at bottom */
.save-tick {
    width: 20px;
    height: 20px;
    background: #28a745;
    border-radius: 50%;
    display: none;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
}

/* Show icons when visible */
.note-indicator .eye-icon.visible,
.note-indicator .save-tick.visible {
    display: flex;
}

/* Expanded note box overlay */
.note-box.expanded {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 500px;
    height: auto;
    min-height: 200px;
    z-index: 1000;
    background: white;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    padding: 12px;
}

.overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 999;
}

.overlay.active {
    display: block;
}

/* Miscellaneous */
.red-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    background-color: #dc3545;
    border-radius: 50%;
    margin-left: 4px;
    vertical-align: middle;
}

.hidden {
    display: none !important;
}
</style>

{% endblock %}

{% block content %}
{% csrf_token %}
<div class="overlay" id="noteOverlay"></div>
<div class="container py-5">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="bi bi-people"></i> Class Management - {{ today|date:"M j, Y" }} <span id="current-time" class="fw-normal text-muted" style="font-size: 0.7em;"></span>
            </h2>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Children in Your Classes</h4>
                    <div>
                        <a href="{% url 'attendance_scan' %}" class="btn btn-primary me-2">
                            <i class="bi bi-qr-code-scan"></i> Scan QR Codes
                        </a>
                        <a href="{% url 'manual_payment' %}" class="btn btn-warning">
                            <i class="bi bi-cash-stack"></i> Manual Payment
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if children_data %}
                        <!-- Filter and Sort Controls -->
                        <div class="mb-3 d-flex flex-wrap gap-3 align-items-center">
                            <div>
                                <label for="classFilter" class="form-label me-2">Filter by Class:</label>
                                <select id="classFilter" class="form-select" style="width: auto; display: inline-block;">
                                    <option value="" {% if not selected_class %}selected{% endif %}>All Classes</option>
                                    <option value="creche" {% if selected_class == 'creche' %}selected{% endif %}>Creche</option>
                                    <option value="tackers" {% if selected_class == 'tackers' %}selected{% endif %}>Little Tackers</option>
                                    <option value="minis" {% if selected_class == 'minis' %}selected{% endif %}>Minis</option>
                                    <option value="nitro" {% if selected_class == 'nitro' %}selected{% endif %}>Nitro</option>
                                    <option value="56ers" {% if selected_class == '56ers' %}selected{% endif %}>56ers</option>
                                </select>
                            </div>

                            <div>
                                <label class="form-label me-2">Sort by:</label>
                                <div class="btn-group" role="group" aria-label="Sort options">
                                    <button type="button"
                                            class="btn btn-outline-primary{% if sort_by == 'first_name' %} active{% endif %}"
                                            onclick="changeSorting('first_name')">
                                        <i class="bi bi-sort-alpha-down"></i> First Name
                                    </button>
                                    <button type="button"
                                            class="btn btn-outline-primary{% if sort_by == 'last_name' %} active{% endif %}"
                                            onclick="changeSorting('last_name')">
                                        <i class="bi bi-sort-alpha-down"></i> Last Name
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Tabs -->
                        <div class="tabs-container">
                            <button class="tab-button active" data-tab="registration">Registration</button>
                            <button class="tab-button" data-tab="notes1">Notes 1</button>
                            <button class="tab-button" data-tab="notes2">Notes 2</button>
                            <button class="tab-button" data-tab="notes3">Notes 3</button>
                        </div>

                        <div class="table-wrapper">
                            <!-- Registration Tab Content -->
                            <div class="tab-content active" data-content="registration">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th style="width: 160px;">Child Name</th>
                                            <th style="width: 100px;">Actions</th>
                                            <th style="width: 100px;">Current Balance</th>
                                            <th style="width: 60px;">Photos</th>
                                            <th style="min-width: 200px;">Medical/Dietary</th>
                                            <th style="width: 80px;">Class</th>
                                            <th style="width: 90px;">Status</th>
                                            <th style="width: 80px;">Times</th>
                                            <th style="width: 140px;">Parent</th>
                                            <th style="width: 140px;">Emergency Contact</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for data in children_data %}
                                            <tr class="child-row" data-class="{{ data.child.child_class }}" data-child-id="{{ data.child.id }}">
                                                <td style="width: 160px;">
                                                    <strong>{{ data.child.first_name }} {{ data.child.last_name }}</strong><br>
                                                    <small class="text-muted">DOB: {{ data.child.date_of_birth|date:"M j, Y" }}</small><br>
                                                    <small class="text-muted" style="font-size: 0.8em; display: flex; align-items: center; gap: 4px;">
                                                        ⛪
                                                        {% if data.child.parent.which_church %}
                                                            {{ data.child.parent.which_church }}
                                                        {% else %}
                                                            None
                                                        {% endif %}
                                                        <span class="red-dot hidden" data-notes-indicator="{{ data.child.id }}"></span>
                                                    </small>
                                                </td>
                                                <td style="width: 100px;">
                                                    <div class="d-grid">
                                                        {% if not data.attendance %}
                                                            <button class="btn btn-success d-flex align-items-center justify-content-center" style="height: 70px; flex-direction: column; font-size: 12px; touch-action: manipulation;"
                                                                    onclick="manualCheckIn({{ data.child.id }}, '{{ data.child.first_name }} {{ data.child.last_name }}')"
                                                                    ontouchend="manualCheckIn({{ data.child.id }}, '{{ data.child.first_name }} {{ data.child.last_name }}')">
                                                                <i class="bi bi-box-arrow-in-right" style="font-size: 16px;"></i>
                                                                <span style="margin-top: 4px;">Check In</span>
                                                            </button>
                                                        {% elif data.attendance.status == 'checked_in' %}
                                                            <button class="btn btn-primary d-flex align-items-center justify-content-center" style="height: 70px; flex-direction: column; font-size: 12px; touch-action: manipulation;"
                                                                    onclick="changeStatus({{ data.child.id }}, 'in_class', '{{ data.child.first_name }} {{ data.child.last_name }}')"
                                                                    ontouchend="changeStatus({{ data.child.id }}, 'in_class', '{{ data.child.first_name }} {{ data.child.last_name }}')">
                                                                <i class="bi bi-book" style="font-size: 16px;"></i>
                                                                <span style="margin-top: 4px;">In Class</span>
                                                            </button>
                                                        {% elif data.attendance.status == 'in_class' %}
                                                            <button class="btn btn-warning d-flex align-items-center justify-content-center" style="height: 70px; flex-direction: column; font-size: 12px; touch-action: manipulation;"
                                                                    onclick="changeStatus({{ data.child.id }}, 'picked_up', '{{ data.child.first_name }} {{ data.child.last_name }}')"
                                                                    ontouchend="changeStatus({{ data.child.id }}, 'picked_up', '{{ data.child.first_name }} {{ data.child.last_name }}')">
                                                                <i class="bi bi-person-check" style="font-size: 16px;"></i>
                                                                <span style="margin-top: 4px;">Picked Up</span>
                                                            </button>
                                                        {% elif data.attendance.status == 'picked_up' %}
                                                            <span class="border border-dark text-dark d-flex align-items-center justify-content-center" style="height: 70px; border-radius: 0.375rem; font-weight: bold;">Complete</span>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                                <td style="width: 100px;">
                                                    {% if data.balance != 0 %}
                                                        <span class="{% if data.balance < 0 %}text-danger{% elif data.balance > 0 %}text-success{% else %}text-muted{% endif %}">
                                                            ${{ data.balance|floatformat:2 }}
                                                        </span>
                                                    {% else %}
                                                        <span class="text-muted">$0.00</span>
                                                    {% endif %}
                                                </td>
                                                <td style="width: 60px; text-align: center;">
                                                    {% if data.child.photo_consent %}
                                                        <span class="badge bg-success" title="Photo consent given"><i class="bi bi-camera"></i></span>
                                                    {% else %}
                                                        <span class="badge bg-danger" title="No photo consent"><i class="bi bi-camera-fill"></i></span>
                                                    {% endif %}
                                                </td>
                                                <td style="min-width: 200px;">
                                                    {% if data.child.has_dietary_needs %}
                                                        <div class="alert alert-warning py-1 mb-1">
                                                            <small><strong>Dietary:</strong> {{ data.child.dietary_needs_detail }}</small>
                                                        </div>
                                                    {% endif %}
                                                    {% if data.child.has_medical_needs %}
                                                        <div class="alert alert-danger py-1 mb-1">
                                                            <small><strong>Medical:</strong> {{ data.child.medical_allergy_details }}</small>
                                                        </div>
                                                    {% endif %}
                                                    {% if not data.child.has_dietary_needs and not data.child.has_medical_needs %}
                                                        <small class="text-muted">None reported</small>
                                                    {% endif %}
                                                </td>
                                                <td style="width: 80px;">
                                                    <small style="line-height: 1.2;">{{ data.child.get_class_short_name }}</small>
                                                </td>
                                                <td style="width: 90px;">
                                                    {% if data.attendance %}
                                                        <span class="badge" style="background-color: {{ data.attendance.get_status_color }}; font-size: 10px;">
                                                            {{ data.attendance.get_status_display }}
                                                        </span>
                                                    {% else %}
                                                        <span class="badge" style="background-color: #6c757d; font-size: 10px;">Not yet arrived</span>
                                                    {% endif %}
                                                </td>
                                                <td style="width: 80px;">
                                                    {% if data.attendance %}
                                                        <small>{{ data.attendance.time_in|time:"H:i" }}</small>
                                                        {% if data.attendance.time_out %}
                                                            <br><small>Out: {{ data.attendance.time_out|time:"H:i" }}</small>
                                                        {% endif %}
                                                    {% else %}
                                                        <small class="text-muted">-</small>
                                                    {% endif %}
                                                </td>
                                                <td style="width: 140px;">
                                                    <strong>{{ data.child.parent.first_name }} {{ data.child.parent.last_name }}</strong><br>
                                                    <small class="text-muted">{{ data.child.parent.phone_number }}</small>
                                                </td>
                                                <td style="width: 140px;">
                                                    <strong>{{ data.child.parent.emergency_contact_name }}</strong><br>
                                                    <small>{{ data.child.parent.emergency_contact_phone }}</small><br>
                                                    <small class="text-muted">{{ data.child.parent.get_emergency_contact_relationship_display }}</small>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            <!-- Notes 1 Tab Content -->
                            <div class="tab-content" data-content="notes1">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th style="width: 160px;">Child Name</th>
                                            <th style="width: 100px;">Actions</th>
                                            <th style="width: 33.33%;">Note 1</th>
                                            <th style="width: 33.33%;">Note 2</th>
                                            <th style="width: 33.34%;">Note 3</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for data in children_data %}
                                            <tr class="child-row" data-class="{{ data.child.child_class }}" data-child-id="{{ data.child.id }}">
                                                <td style="width: 160px;">
                                                    <strong>{{ data.child.first_name }} {{ data.child.last_name }}</strong><br>
                                                    <small class="text-muted">DOB: {{ data.child.date_of_birth|date:"M j, Y" }}</small><br>
                                                    <small class="text-muted" style="font-size: 0.8em; display: flex; align-items: center; gap: 4px;">
                                                        ⛪
                                                        {% if data.child.parent.which_church %}
                                                            {{ data.child.parent.which_church }}
                                                        {% else %}
                                                            None
                                                        {% endif %}
                                                        <span class="red-dot hidden" data-notes-indicator="{{ data.child.id }}"></span>
                                                    </small>
                                                </td>
                                                <td style="width: 100px;">
                                                    <div class="d-grid">
                                                        {% if not data.attendance %}
                                                            <button class="btn btn-success d-flex align-items-center justify-content-center" style="height: 70px; flex-direction: column; font-size: 12px; touch-action: manipulation;"
                                                                    onclick="manualCheckIn({{ data.child.id }}, '{{ data.child.first_name }} {{ data.child.last_name }}')"
                                                                    ontouchend="manualCheckIn({{ data.child.id }}, '{{ data.child.first_name }} {{ data.child.last_name }}')">
                                                                <i class="bi bi-box-arrow-in-right" style="font-size: 16px;"></i>
                                                                <span style="margin-top: 4px;">Check In</span>
                                                            </button>
                                                        {% elif data.attendance.status == 'checked_in' %}
                                                            <button class="btn btn-primary d-flex align-items-center justify-content-center" style="height: 70px; flex-direction: column; font-size: 12px; touch-action: manipulation;"
                                                                    onclick="changeStatus({{ data.child.id }}, 'in_class', '{{ data.child.first_name }} {{ data.child.last_name }}')"
                                                                    ontouchend="changeStatus({{ data.child.id }}, 'in_class', '{{ data.child.first_name }} {{ data.child.last_name }}')">
                                                                <i class="bi bi-book" style="font-size: 16px;"></i>
                                                                <span style="margin-top: 4px;">In Class</span>
                                                            </button>
                                                        {% elif data.attendance.status == 'in_class' %}
                                                            <button class="btn btn-warning d-flex align-items-center justify-content-center" style="height: 70px; flex-direction: column; font-size: 12px; touch-action: manipulation;"
                                                                    onclick="changeStatus({{ data.child.id }}, 'picked_up', '{{ data.child.first_name }} {{ data.child.last_name }}')"
                                                                    ontouchend="changeStatus({{ data.child.id }}, 'picked_up', '{{ data.child.first_name }} {{ data.child.last_name }}')">
                                                                <i class="bi bi-person-check" style="font-size: 16px;"></i>
                                                                <span style="margin-top: 4px;">Picked Up</span>
                                                            </button>
                                                        {% elif data.attendance.status == 'picked_up' %}
                                                            <span class="border border-dark text-dark d-flex align-items-center justify-content-center" style="height: 70px; border-radius: 0.375rem; font-weight: bold;">Complete</span>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                                <td class="note-box-container">
                                                    <textarea class="note-box" data-child-id="{{ data.child.id }}" data-note-field="note1_1" placeholder="Enter note..."></textarea>
                                                    <div class="note-indicator">
                                                        <div class="eye-icon"><i class="bi bi-eye"></i></div>
                                                        <div class="save-tick"><i class="bi bi-check"></i></div>
                                                    </div>
                                                </td>
                                                <td class="note-box-container">
                                                    <textarea class="note-box" data-child-id="{{ data.child.id }}" data-note-field="note1_2" placeholder="Enter note..."></textarea>
                                                    <div class="note-indicator">
                                                        <div class="eye-icon"><i class="bi bi-eye"></i></div>
                                                        <div class="save-tick"><i class="bi bi-check"></i></div>
                                                    </div>
                                                </td>
                                                <td class="note-box-container">
                                                    <textarea class="note-box" data-child-id="{{ data.child.id }}" data-note-field="note1_3" placeholder="Enter note..."></textarea>
                                                    <div class="note-indicator">
                                                        <div class="eye-icon"><i class="bi bi-eye"></i></div>
                                                        <div class="save-tick"><i class="bi bi-check"></i></div>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            <!-- Notes 2 Tab Content -->
                            <div class="tab-content" data-content="notes2">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th style="width: 160px;">Child Name</th>
                                            <th style="width: 100px;">Actions</th>
                                            <th style="width: 33.33%;">Note 4</th>
                                            <th style="width: 33.33%;">Note 5</th>
                                            <th style="width: 33.34%;">Note 6</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for data in children_data %}
                                            <tr class="child-row" data-class="{{ data.child.child_class }}" data-child-id="{{ data.child.id }}">
                                                <td style="width: 160px;">
                                                    <strong>{{ data.child.first_name }} {{ data.child.last_name }}</strong><br>
                                                    <small class="text-muted">DOB: {{ data.child.date_of_birth|date:"M j, Y" }}</small><br>
                                                    <small class="text-muted" style="font-size: 0.8em; display: flex; align-items: center; gap: 4px;">
                                                        ⛪
                                                        {% if data.child.parent.which_church %}
                                                            {{ data.child.parent.which_church }}
                                                        {% else %}
                                                            None
                                                        {% endif %}
                                                        <span class="red-dot hidden" data-notes-indicator="{{ data.child.id }}"></span>
                                                    </small>
                                                </td>
                                                <td style="width: 100px;">
                                                    <div class="d-grid">
                                                        {% if not data.attendance %}
                                                            <button class="btn btn-success d-flex align-items-center justify-content-center" style="height: 70px; flex-direction: column; font-size: 12px; touch-action: manipulation;"
                                                                    onclick="manualCheckIn({{ data.child.id }}, '{{ data.child.first_name }} {{ data.child.last_name }}')"
                                                                    ontouchend="manualCheckIn({{ data.child.id }}, '{{ data.child.first_name }} {{ data.child.last_name }}')">
                                                                <i class="bi bi-box-arrow-in-right" style="font-size: 16px;"></i>
                                                                <span style="margin-top: 4px;">Check In</span>
                                                            </button>
                                                        {% elif data.attendance.status == 'checked_in' %}
                                                            <button class="btn btn-primary d-flex align-items-center justify-content-center" style="height: 70px; flex-direction: column; font-size: 12px; touch-action: manipulation;"
                                                                    onclick="changeStatus({{ data.child.id }}, 'in_class', '{{ data.child.first_name }} {{ data.child.last_name }}')"
                                                                    ontouchend="changeStatus({{ data.child.id }}, 'in_class', '{{ data.child.first_name }} {{ data.child.last_name }}')">
                                                                <i class="bi bi-book" style="font-size: 16px;"></i>
                                                                <span style="margin-top: 4px;">In Class</span>
                                                            </button>
                                                        {% elif data.attendance.status == 'in_class' %}
                                                            <button class="btn btn-warning d-flex align-items-center justify-content-center" style="height: 70px; flex-direction: column; font-size: 12px; touch-action: manipulation;"
                                                                    onclick="changeStatus({{ data.child.id }}, 'picked_up', '{{ data.child.first_name }} {{ data.child.last_name }}')"
                                                                    ontouchend="changeStatus({{ data.child.id }}, 'picked_up', '{{ data.child.first_name }} {{ data.child.last_name }}')">
                                                                <i class="bi bi-person-check" style="font-size: 16px;"></i>
                                                                <span style="margin-top: 4px;">Picked Up</span>
                                                            </button>
                                                        {% elif data.attendance.status == 'picked_up' %}
                                                            <span class="border border-dark text-dark d-flex align-items-center justify-content-center" style="height: 70px; border-radius: 0.375rem; font-weight: bold;">Complete</span>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                                <td class="note-box-container">
                                                    <textarea class="note-box" data-child-id="{{ data.child.id }}" data-note-field="note2_1" placeholder="Enter note..."></textarea>
                                                    <div class="note-indicator">
                                                        <div class="eye-icon"><i class="bi bi-eye"></i></div>
                                                        <div class="save-tick"><i class="bi bi-check"></i></div>
                                                    </div>
                                                </td>
                                                <td class="note-box-container">
                                                    <textarea class="note-box" data-child-id="{{ data.child.id }}" data-note-field="note2_2" placeholder="Enter note..."></textarea>
                                                    <div class="note-indicator">
                                                        <div class="eye-icon"><i class="bi bi-eye"></i></div>
                                                        <div class="save-tick"><i class="bi bi-check"></i></div>
                                                    </div>
                                                </td>
                                                <td class="note-box-container">
                                                    <textarea class="note-box" data-child-id="{{ data.child.id }}" data-note-field="note2_3" placeholder="Enter note..."></textarea>
                                                    <div class="note-indicator">
                                                        <div class="eye-icon"><i class="bi bi-eye"></i></div>
                                                        <div class="save-tick"><i class="bi bi-check"></i></div>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            <!-- Notes 3 Tab Content -->
                            <div class="tab-content" data-content="notes3">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th style="width: 160px;">Child Name</th>
                                            <th style="width: 100px;">Actions</th>
                                            <th style="width: 33.33%;">Note 7</th>
                                            <th style="width: 33.33%;">Note 8</th>
                                            <th style="width: 33.34%;">Note 9</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for data in children_data %}
                                            <tr class="child-row" data-class="{{ data.child.child_class }}" data-child-id="{{ data.child.id }}">
                                                <td style="width: 160px;">
                                                    <strong>{{ data.child.first_name }} {{ data.child.last_name }}</strong><br>
                                                    <small class="text-muted">DOB: {{ data.child.date_of_birth|date:"M j, Y" }}</small><br>
                                                    <small class="text-muted" style="font-size: 0.8em; display: flex; align-items: center; gap: 4px;">
                                                        ⛪
                                                        {% if data.child.parent.which_church %}
                                                            {{ data.child.parent.which_church }}
                                                        {% else %}
                                                            None
                                                        {% endif %}
                                                        <span class="red-dot hidden" data-notes-indicator="{{ data.child.id }}"></span>
                                                    </small>
                                                </td>
                                                <td style="width: 100px;">
                                                    <div class="d-grid">
                                                        {% if not data.attendance %}
                                                            <button class="btn btn-success d-flex align-items-center justify-content-center" style="height: 70px; flex-direction: column; font-size: 12px; touch-action: manipulation;"
                                                                    onclick="manualCheckIn({{ data.child.id }}, '{{ data.child.first_name }} {{ data.child.last_name }}')"
                                                                    ontouchend="manualCheckIn({{ data.child.id }}, '{{ data.child.first_name }} {{ data.child.last_name }}')">
                                                                <i class="bi bi-box-arrow-in-right" style="font-size: 16px;"></i>
                                                                <span style="margin-top: 4px;">Check In</span>
                                                            </button>
                                                        {% elif data.attendance.status == 'checked_in' %}
                                                            <button class="btn btn-primary d-flex align-items-center justify-content-center" style="height: 70px; flex-direction: column; font-size: 12px; touch-action: manipulation;"
                                                                    onclick="changeStatus({{ data.child.id }}, 'in_class', '{{ data.child.first_name }} {{ data.child.last_name }}')"
                                                                    ontouchend="changeStatus({{ data.child.id }}, 'in_class', '{{ data.child.first_name }} {{ data.child.last_name }}')">
                                                                <i class="bi bi-book" style="font-size: 16px;"></i>
                                                                <span style="margin-top: 4px;">In Class</span>
                                                            </button>
                                                        {% elif data.attendance.status == 'in_class' %}
                                                            <button class="btn btn-warning d-flex align-items-center justify-content-center" style="height: 70px; flex-direction: column; font-size: 12px; touch-action: manipulation;"
                                                                    onclick="changeStatus({{ data.child.id }}, 'picked_up', '{{ data.child.first_name }} {{ data.child.last_name }}')"
                                                                    ontouchend="changeStatus({{ data.child.id }}, 'picked_up', '{{ data.child.first_name }} {{ data.child.last_name }}')">
                                                                <i class="bi bi-person-check" style="font-size: 16px;"></i>
                                                                <span style="margin-top: 4px;">Picked Up</span>
                                                            </button>
                                                        {% elif data.attendance.status == 'picked_up' %}
                                                            <span class="border border-dark text-dark d-flex align-items-center justify-content-center" style="height: 70px; border-radius: 0.375rem; font-weight: bold;">Complete</span>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                                <td class="note-box-container">
                                                    <textarea class="note-box" data-child-id="{{ data.child.id }}" data-note-field="note3_1" placeholder="Enter note..."></textarea>
                                                    <div class="note-indicator">
                                                        <div class="eye-icon"><i class="bi bi-eye"></i></div>
                                                        <div class="save-tick"><i class="bi bi-check"></i></div>
                                                    </div>
                                                </td>
                                                <td class="note-box-container">
                                                    <textarea class="note-box" data-child-id="{{ data.child.id }}" data-note-field="note3_2" placeholder="Enter note..."></textarea>
                                                    <div class="note-indicator">
                                                        <div class="eye-icon"><i class="bi bi-eye"></i></div>
                                                        <div class="save-tick"><i class="bi bi-check"></i></div>
                                                    </div>
                                                </td>
                                                <td class="note-box-container">
                                                    <textarea class="note-box" data-child-id="{{ data.child.id }}" data-note-field="note3_3" placeholder="Enter note..."></textarea>
                                                    <div class="note-indicator">
                                                        <div class="eye-icon"><i class="bi bi-eye"></i></div>
                                                        <div class="save-tick"><i class="bi bi-check"></i></div>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Summary Stats -->
                        <div class="row mt-4 text-center">
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="card text-white status-grey">
                                    <div class="card-body">
                                        <h5>Not Yet Arrived</h5>
                                        <h2 id="notYetArrivedCount">0</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="card text-white status-green">
                                    <div class="card-body">
                                        <h5>Checked In</h5>
                                        <h2 id="checkedInCount">0</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="card text-white status-blue">
                                    <div class="card-body">
                                        <h5>In Class</h5>
                                        <h2 id="inClassCount">0</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="card text-white status-purple">
                                    <div class="card-body">
                                        <h5>Picked Up</h5>
                                        <h2 id="pickedUpCount">0</h2>
                                    </div>
                                </div>
                            </div>
                        </div>

                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-people" style="font-size: 4rem; color: #ccc;"></i>
                            <h5 class="mt-3">No children registered yet</h5>
                            <p class="text-muted">Children will appear here once parents complete their registration.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const notesData = {};

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing...');
    const classFilter = document.getElementById('classFilter');
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    const noteBoxes = document.querySelectorAll('.note-box');
    const overlay = document.getElementById('noteOverlay');

    console.log('Found tab buttons:', tabButtons.length);
    console.log('Found tab contents:', tabContents.length);

    loadNotesFromStorage();
    loadNotesFromServer();

    // Tab order for animation direction
    const tabOrder = ['registration', 'notes1', 'notes2', 'notes3'];
    let currentTabIndex = 0;

    // Tab switching functionality with animation
    tabButtons.forEach((button, index) => {
        button.addEventListener('click', function() {
            const tabName = this.dataset.tab;
            const newTabIndex = tabOrder.indexOf(tabName);
            console.log('Switching to tab:', tabName);

            if (newTabIndex === currentTabIndex) return;

            const direction = newTabIndex > currentTabIndex ? 'left' : 'right';

            // Find currently active tab
            const currentActive = document.querySelector('.tab-content.active');

            // Add slide out animation to current tab
            if (currentActive) {
                currentActive.classList.add(direction === 'left' ? 'slide-out-left' : 'slide-out-right');

                // Wait for animation to complete before hiding
                setTimeout(() => {
                    currentActive.classList.remove('active', 'slide-out-left', 'slide-out-right');
                }, 300);
            }

            // Update button states
            tabButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');

            // Show new tab with slide in animation
            tabContents.forEach(content => {
                if (content.dataset.content === tabName) {
                    setTimeout(() => {
                        content.classList.add('active');
                    }, currentActive ? 300 : 0);
                }
            });

            currentTabIndex = newTabIndex;
        });
    });

    // Note box functionality
    noteBoxes.forEach(noteBox => {
        const container = noteBox.closest('.note-box-container');
        const eyeIcon = container.querySelector('.eye-icon');
        const saveTick = container.querySelector('.save-tick');
        let saveTimeout;

        noteBox.addEventListener('blur', function() {
            if (!this.classList.contains('expanded')) {
                checkOverflow(this);
            }
        });

        noteBox.addEventListener('input', function() {
            clearTimeout(saveTimeout);
            saveTick.classList.remove('visible');

            saveTimeout = setTimeout(() => {
                saveNote(this);
                saveTick.classList.add('visible');
                setTimeout(() => {
                    saveTick.classList.remove('visible');
                }, 2000);
            }, 500);
        });

        if (eyeIcon) {
            eyeIcon.addEventListener('click', function(e) {
                e.stopPropagation();
                noteBox.classList.add('expanded');
                overlay.classList.add('active');
                noteBox.focus();
                eyeIcon.classList.remove('visible');
            });
        }

        noteBox.addEventListener('blur', function() {
            setTimeout(() => {
                if (this.classList.contains('expanded')) {
                    this.classList.remove('expanded');
                    overlay.classList.remove('active');
                    checkOverflow(this);
                }
            }, 200);
        });

        checkOverflow(noteBox);
    });

    overlay.addEventListener('click', function() {
        const expandedBox = document.querySelector('.note-box.expanded');
        if (expandedBox) {
            expandedBox.classList.remove('expanded');
            expandedBox.blur();
            overlay.classList.remove('active');
            checkOverflow(expandedBox);
        }
    });

    function checkOverflow(noteBox) {
        const container = noteBox.closest('.note-box-container');
        const eyeIcon = container.querySelector('.eye-icon');

        if (noteBox.scrollHeight > noteBox.clientHeight && noteBox.value.trim() !== '') {
            eyeIcon.classList.add('visible');
        } else {
            eyeIcon.classList.remove('visible');
        }
    }

    function saveNote(noteBox) {
        const childId = noteBox.dataset.childId;
        const noteField = noteBox.dataset.noteField;
        const value = noteBox.value;

        if (!notesData[childId]) {
            notesData[childId] = {};
        }

        notesData[childId][noteField] = value;

        // ✅ Save to localStorage (backup/offline)
        localStorage.setItem('teacherNotes', JSON.stringify(notesData));

        // ✅ Save to server (primary storage)
        fetch(`/api/notes/save/${childId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(notesData[childId])
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success' || data.status === 'ok') {
                console.log(`Notes saved for child ${childId}`);
            } else {
                console.error('Failed to save notes:', data.message);
                alert('Failed to save notes to server. Notes saved locally only.');
            }
        })
        .catch(error => {
            console.error('Error saving notes:', error);
            alert('Error saving notes to server. Notes saved locally only.');
        });

        updateRedDotIndicator(childId);

        if (value.trim() !== '') {
            noteBox.classList.add('has-content');
        } else {
            noteBox.classList.remove('has-content');
        }
    }


    function loadNotesFromStorage() {
        // First try to load from localStorage (fast, for offline)
        const stored = localStorage.getItem('teacherNotes');
        if (stored) {
            Object.assign(notesData, JSON.parse(stored));
        }

        // Then load from server (source of truth)
        loadNotesFromServer();
    }

    function loadNotesFromServer() {
        // Get all unique child IDs from the page
        const childIds = new Set();
        document.querySelectorAll('.note-box').forEach(box => {
            childIds.add(box.dataset.childId);
        });

        // Load notes for each child
        childIds.forEach(childId => {
            fetch(`/api/notes/load/${childId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.notes) {
                        // Merge server data with local data (server wins)
                        notesData[childId] = { ...notesData[childId], ...data.notes };

                        // Update UI with server data
                        document.querySelectorAll(`.note-box[data-child-id="${childId}"]`).forEach(noteBox => {
                            const noteField = noteBox.dataset.noteField;
                            if (data.notes[noteField]) {
                                noteBox.value = data.notes[noteField];
                                noteBox.classList.add('has-content');
                                checkOverflow(noteBox);
                            }
                        });

                        updateRedDotIndicator(childId);
                    }
                })
                .catch(error => {
                    console.error(`Error loading notes for child ${childId}:`, error);
                    // Silently fail - will use localStorage if available
                });
        });

        // Save merged data back to localStorage
        localStorage.setItem('teacherNotes', JSON.stringify(notesData));
    }

    function updateRedDotIndicator(childId) {
        const redDots = document.querySelectorAll(`[data-notes-indicator="${childId}"]`);
        const hasNotes = notesData[childId] && Object.values(notesData[childId]).some(note => note && note.trim() !== '');

        redDots.forEach(redDot => {
            if (hasNotes) {
                redDot.classList.remove('hidden');
            } else {
                redDot.classList.add('hidden');
            }
        });
    }

    function updateCurrentTime() {
        const now = new Date();
        const sydneyTime = new Date(now.toLocaleString("en-US", {timeZone: "Australia/Sydney"}));
        const timeString = sydneyTime.toLocaleTimeString('en-AU', {
            hour12: false,
            hour: '2-digit',
            minute: '2-digit'
        });
        const timeElement = document.getElementById('current-time');
        if (timeElement) {
            timeElement.textContent = `(${timeString})`;
        }
    }

    updateCurrentTime();
    setInterval(updateCurrentTime, 60000);

    if (classFilter) {
        classFilter.addEventListener('change', function() {
            const selectedClass = this.value;
            const url = new URL(window.location);
            if (selectedClass) {
                url.searchParams.set('class', selectedClass);
            } else {
                url.searchParams.delete('class');
            }
            const currentSort = url.searchParams.get('sort');
            if (currentSort) {
                url.searchParams.set('sort', currentSort);
            }
            window.location.href = url.toString();
        });
    }

    function updateCounts() {
        let notYetArrivedCount = 0;
        let checkedInCount = 0;
        let inClassCount = 0;
        let pickedUpCount = 0;

        const registrationRows = document.querySelectorAll('[data-content="registration"] .child-row');
        registrationRows.forEach(row => {
            const statusBadge = row.querySelector('td:nth-child(7) .badge');
            if (statusBadge) {
                const statusText = statusBadge.textContent.trim();
                if (statusText === 'Not yet arrived') {
                    notYetArrivedCount++;
                } else if (statusText === 'Checked in') {
                    checkedInCount++;
                } else if (statusText === 'In class') {
                    inClassCount++;
                } else if (statusText === 'Picked up') {
                    pickedUpCount++;
                }
            }
        });

        document.getElementById('notYetArrivedCount').textContent = notYetArrivedCount;
        document.getElementById('checkedInCount').textContent = checkedInCount;
        document.getElementById('inClassCount').textContent = inClassCount;
        document.getElementById('pickedUpCount').textContent = pickedUpCount;
    }

    updateCounts();
});

function manualCheckIn(childId, childName) {
    if (confirm(`Check in ${childName}?`)) {
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="bi bi-hourglass-split"></i><span style="margin-top: 4px;">Loading...</span>';
        button.disabled = true;

        fetch(`/manual_checkin/${childId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                reloadWithFilter();
            } else if (data.status === 'payment_required') {
                alert(`Payment Required: ${data.message}\n\nCurrent Balance: ${data.current_balance}\nRequired: ${data.required_charge}\nShortfall: ${data.shortfall}`);
                button.innerHTML = originalText;
                button.disabled = false;
            } else {
                alert(data.message || 'An error occurred');
                button.innerHTML = originalText;
                button.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while checking in the child.');
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
}

function changeStatus(childId, newStatus, childName) {
    const statusNames = {
        'in_class': 'In Class',
        'picked_up': 'Picked Up'
    };

    if (confirm(`Change ${childName} status to ${statusNames[newStatus]}?`)) {
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="bi bi-hourglass-split"></i><span style="margin-top: 4px;">Loading...</span>';
        button.disabled = true;

        fetch(`/change_status/${childId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({status: newStatus})
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                reloadWithFilter();
            } else {
                alert(data.message || 'An error occurred');
                button.innerHTML = originalText;
                button.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating status.');
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
}

function reloadWithFilter() {
    location.reload();
}

function getCurrentFilter() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('class') || '';
}

function changeSorting(sortBy) {
    const url = new URL(window.location);
    url.searchParams.set('sort', sortBy);
    const currentClass = url.searchParams.get('class');
    if (currentClass) {
        url.searchParams.set('class', currentClass);
    }
    window.location.href = url.toString();
}

function getNotesForExport() {
    return notesData;
}
</script>
{% endblock %}
