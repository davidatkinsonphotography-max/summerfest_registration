{% extends 'base.html' %}

{% block title %}QR Code Scanner - Summerfest{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0"><i class="bi bi-qr-code-scan"></i> Child Check-in Scanner</h3>
                </div>
                <div class="card-body">
                    
                    <!-- Camera Scanner Section -->
                    <div class="text-center mb-4">
                        <button id="startScanBtn" class="btn btn-success btn-lg me-3">
                            <i class="bi bi-camera"></i> Start Camera Scanner
                        </button>
                        <button id="stopScanBtn" class="btn btn-secondary btn-lg" style="display: none;">
                            <i class="bi bi-stop-circle"></i> Stop Scanner
                        </button>
                    </div>
                    
                    <!-- Camera View -->
                    <div id="cameraSection" style="display: none;" class="text-center mb-4">
                        <div class="position-relative d-inline-block">
                            <div id="preview" style="width: 400px; height: 300px; border: 1px solid #ccc; border-radius: 8px;"></div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Point camera at QR code</small>
                        </div>
                    </div>
                    
                    <!-- Manual Entry Fallback -->
                    <div class="text-center mb-3">
                        <button id="toggleManualBtn" class="btn btn-outline-secondary">
                            <i class="bi bi-keyboard"></i> Enter Code Manually
                        </button>
                    </div>
                    
                    <div id="manualEntrySection" style="display: none;">
                        <form id="scanForm" method="post">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="{{ form.qr_code_data.id_for_label }}" class="form-label">QR Code Data</label>
                                {{ form.qr_code_data }}
                                <small class="form-text text-muted">
                                    Enter or paste the QR code data manually
                                </small>
                            </div>
                            
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="bi bi-check-circle"></i> Check In Child
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Scan Result Display -->
                    <div id="scanResult" class="mt-4" style="display: none;">
                        <div class="alert" id="resultAlert">
                            <div id="resultMessage"></div>
                        </div>
                    </div>
                    
                    <!-- Persistent Check-in List -->
                    <div id="checkinList" class="mt-4" style="display: none;">
                        <div class="card">
                            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-list-check"></i> Today's Check-ins</h5>
                                <button id="clearListBtn" class="btn btn-sm btn-outline-light">
                                    <i class="bi bi-trash"></i> Clear List
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                    <table class="table table-sm table-hover mb-0">
                                        <thead class="table-dark sticky-top">
                                            <tr>
                                                <th>Time</th>
                                                <th>Child Name</th>
                                                <th>Class</th>
                                                <th>Dietary</th>
                                                <th>Medical</th>
                                                <th>Photo</th>
                                            </tr>
                                        </thead>
                                        <tbody id="checkinListBody">
                                            <!-- Check-ins will be added here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Instructions -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> How to Use</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="bi bi-camera text-success"></i> Camera Scanner (Recommended)</h6>
                            <ol>
                                <li>Click "Start Camera Scanner"</li>
                                <li>Allow camera access when prompted</li>
                                <li>Point camera at child's QR code</li>
                                <li>QR code will be automatically scanned and processed</li>
                            </ol>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="bi bi-keyboard text-info"></i> Manual Entry (Fallback)</h6>
                            <ol>
                                <li>Click "Enter Code Manually"</li>
                                <li>Use phone QR scanner app to read code</li>
                                <li>Copy and paste the code into the text field</li>
                                <li>Click "Check In Child"</li>
                            </ol>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <strong>Note:</strong> Each child can only be checked in once per day. 
                        Camera access is required for automatic scanning.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Include QR Scanner Library -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const startScanBtn = document.getElementById('startScanBtn');
    const stopScanBtn = document.getElementById('stopScanBtn');
    const cameraSection = document.getElementById('cameraSection');
    const toggleManualBtn = document.getElementById('toggleManualBtn');
    const manualEntrySection = document.getElementById('manualEntrySection');
    const form = document.getElementById('scanForm');
    const resultDiv = document.getElementById('scanResult');
    const resultAlert = document.getElementById('resultAlert');
    const resultMessage = document.getElementById('resultMessage');
    const checkinList = document.getElementById('checkinList');
    const checkinListBody = document.getElementById('checkinListBody');
    const clearListBtn = document.getElementById('clearListBtn');
    
    let html5QrcodeScanner = null;
    let checkinData = JSON.parse(localStorage.getItem('summerfest_checkins') || '[]');

    // Initialize check-in list
    loadCheckinList();
    
    // Clear list button
    clearListBtn.addEventListener('click', function() {
        if (confirm('Are you sure you want to clear the check-in list?')) {
            checkinData = [];
            localStorage.removeItem('summerfest_checkins');
            loadCheckinList();
        }
    });

    // Start camera scanner
    startScanBtn.addEventListener('click', function() {
        startCameraScanner();
    });

    // Stop camera scanner
    stopScanBtn.addEventListener('click', function() {
        stopCameraScanner();
    });

    // Toggle manual entry
    toggleManualBtn.addEventListener('click', function() {
        if (manualEntrySection.style.display === 'none') {
            manualEntrySection.style.display = 'block';
            toggleManualBtn.innerHTML = '<i class="bi bi-camera"></i> Use Camera Instead';
            stopCameraScanner();
        } else {
            manualEntrySection.style.display = 'none';
            toggleManualBtn.innerHTML = '<i class="bi bi-keyboard"></i> Enter Code Manually';
        }
    });

    function startCameraScanner() {
        const config = { 
            fps: 10, 
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.333334,
            disableFlip: false
        };

        html5QrcodeScanner = new Html5QrcodeScanner(
            "preview", 
            config, 
            false
        );
        
        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        
        // Update UI
        startScanBtn.style.display = 'none';
        stopScanBtn.style.display = 'inline-block';
        cameraSection.style.display = 'block';
        manualEntrySection.style.display = 'none';
    }

    function stopCameraScanner() {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.clear().then(ignore => {
                // Scanner stopped
            }).catch(err => {
                console.log("Error stopping scanner:", err);
            });
            html5QrcodeScanner = null;
        }
        
        // Update UI
        startScanBtn.style.display = 'inline-block';
        stopScanBtn.style.display = 'none';
        cameraSection.style.display = 'none';
    }

    function onScanSuccess(decodedText, decodedResult) {
        // Stop scanning immediately after successful scan
        stopCameraScanner();
        
        // Process the scanned QR code
        processQRCode(decodedText);
    }

    function onScanFailure(error) {
        // Handle scan failure (usually just means no QR code in view)
        // Don't log every failure as it's normal
    }

    function processQRCode(qrCodeData) {
        // Create form data
        const formData = new FormData();
        formData.append('qr_code_data', qrCodeData);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        // Submit to server
        fetch('{% url "attendance_scan" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            showResult(data);
        })
        .catch(error => {
            showError('An error occurred while processing the scan');
        });
    }

    function showResult(data) {
        resultDiv.style.display = 'block';
        
        if (data.status === 'success') {
            resultAlert.className = 'alert alert-success';
            resultMessage.innerHTML = `
                <h5><i class="bi bi-check-circle"></i> Success!</h5>
                <p><strong>${data.child_name}</strong> has been checked in at ${data.time}</p>
                <p>Class: ${data.class}</p>
            `;
            
            // Add to persistent check-in list
            addToCheckinList({
                child_name: data.child_name,
                class: data.class,
                time: data.time,
                dietary_needs: data.dietary_needs || false,
                medical_needs: data.medical_needs || false,
                photo_consent: data.photo_consent || true,
                dietary_details: data.dietary_details || '',
                medical_details: data.medical_details || ''
            });
            
        } else if (data.status === 'already_checked_in') {
            resultAlert.className = 'alert alert-warning';
            resultMessage.innerHTML = `
                <h5><i class="bi bi-exclamation-triangle"></i> Already Checked In</h5>
                <p><strong>${data.child_name}</strong> is already checked in today</p>
                <p>Class: ${data.class}</p>
            `;
        } else if (data.status === 'insufficient_funds') {
            resultAlert.className = 'alert alert-danger';
            resultMessage.innerHTML = `
                <h5><i class="bi bi-credit-card"></i> Insufficient Funds</h5>
                <p><strong>${data.child_name}</strong> - ${data.message}</p>
                <p>Current balance: $${data.balance}</p>
                <p>Required: $${data.required}</p>
            `;
        } else {
            resultAlert.className = 'alert alert-danger';
            resultMessage.innerHTML = `
                <h5><i class="bi bi-x-circle"></i> Error</h5>
                <p>${data.message}</p>
            `;
        }
        
        // Auto-hide result after 5 seconds and restart scanner
        setTimeout(function() {
            resultDiv.style.display = 'none';
            if (!manualEntrySection.style.display || manualEntrySection.style.display === 'none') {
                startCameraScanner();
            }
        }, 5000);
    }

    function showError(message) {
        resultDiv.style.display = 'block';
        resultAlert.className = 'alert alert-danger';
        resultMessage.innerHTML = `
            <h5><i class="bi bi-x-circle"></i> Error</h5>
            <p>${message}</p>
        `;
    }

    // Manual form submission
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const qrInput = form.querySelector('input[name="qr_code_data"]');
            if (qrInput.value) {
                processQRCode(qrInput.value);
                qrInput.value = ''; // Clear input
            }
        });
    }
    
    // Check-in list management functions
    function addToCheckinList(childData) {
        // Add timestamp if not provided
        if (!childData.timestamp) {
            childData.timestamp = new Date().toISOString();
        }
        
        // Check if child is already in today's list (prevent duplicates)
        const today = new Date().toDateString();
        const existingIndex = checkinData.findIndex(item => 
            item.child_name === childData.child_name && 
            new Date(item.timestamp).toDateString() === today
        );
        
        if (existingIndex === -1) {
            // Add new entry at the beginning (newest first)
            checkinData.unshift(childData);
            
            // Keep only last 100 entries to prevent localStorage bloat
            if (checkinData.length > 100) {
                checkinData = checkinData.slice(0, 100);
            }
            
            // Save to localStorage
            localStorage.setItem('summerfest_checkins', JSON.stringify(checkinData));
            
            // Refresh the list display
            loadCheckinList();
        }
    }
    
    function loadCheckinList() {
        // Clear existing list
        checkinListBody.innerHTML = '';
        
        // Filter to only show today's check-ins
        const today = new Date().toDateString();
        const todaysCheckins = checkinData.filter(item => 
            new Date(item.timestamp).toDateString() === today
        );
        
        if (todaysCheckins.length === 0) {
            checkinList.style.display = 'none';
            return;
        }
        
        // Show the list
        checkinList.style.display = 'block';
        
        // Add each check-in to the table
        todaysCheckins.forEach(function(item) {
            const row = document.createElement('tr');
            
            // Format time
            const time = new Date(item.timestamp || item.time).toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Color-coded badges for dietary, medical, and photo
            const dietaryBadge = item.dietary_needs ? 
                `<span class="badge bg-warning text-dark" title="${item.dietary_details}">‚ö†Ô∏è Diet</span>` : 
                `<span class="badge bg-success">‚úì</span>`;
                
            const medicalBadge = item.medical_needs ? 
                `<span class="badge bg-danger" title="${item.medical_details}">üè• Med</span>` : 
                `<span class="badge bg-success">‚úì</span>`;
                
            const photoBadge = item.photo_consent ? 
                `<span class="badge bg-success">üì∏ OK</span>` : 
                `<span class="badge bg-warning text-dark">üì∏ NO</span>`;
            
            row.innerHTML = `
                <td><small>${time}</small></td>
                <td><strong>${item.child_name}</strong></td>
                <td><span class="badge bg-info">${item.class}</span></td>
                <td>${dietaryBadge}</td>
                <td>${medicalBadge}</td>
                <td>${photoBadge}</td>
            `;
            
            checkinListBody.appendChild(row);
        });
    }
});
</script>
{% endblock %}
