{% extends 'base.html' %}

{% block title %}Add Child - Summerfest{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h3 class="mb-0"><i class="bi bi-plus-circle"></i> Add Child</h3>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        <!-- Basic Child Information -->
                        <h4 class="text-success mt-4 mb-3">Child Information</h4>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.first_name.id_for_label }}" class="form-label">First Name *</label>
                                {{ form.first_name }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.last_name.id_for_label }}" class="form-label">Last Name *</label>
                                {{ form.last_name }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.date_of_birth.id_for_label }}" class="form-label">Date of Birth *</label>
                                {{ form.date_of_birth }}
                                <small class="form-text text-muted">{{ form.date_of_birth.help_text }}</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Gender *</label>
                                <div class="form-check-container">
                                    {% for choice in form.gender %}
                                        <div class="form-check">
                                            {{ choice.tag }}
                                            <label class="form-check-label" for="{{ choice.id_for_label }}">
                                                {{ choice.choice_label }}
                                            </label>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Which class will your child attend? *</label>
                            <div class="form-check-container">
                                {% for choice in form.child_class %}
                                    <div class="form-check">
                                        {{ choice.tag }}
                                        <label class="form-check-label" for="{{ choice.id_for_label }}">
                                            {{ choice.choice_label }}
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Health Information -->
                        <h4 class="text-success mt-4 mb-3">Health Information</h4>
                        
                        <div class="mb-3">
                            <label class="form-label">{{ form.has_dietary_needs.label }} *</label>
                            <div class="form-check-container">
                                {% for choice in form.has_dietary_needs %}
                                    <div class="form-check">
                                        {{ choice.tag }}
                                        <label class="form-check-label" for="{{ choice.id_for_label }}">
                                            {{ choice.choice_label }}
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="mb-3" id="dietary-detail-container">
                            <label for="{{ form.dietary_needs_detail.id_for_label }}" class="form-label">Dietary Needs Details</label>
                            {{ form.dietary_needs_detail }}
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">{{ form.has_medical_needs.label }} *</label>
                            <div class="form-check-container">
                                {% for choice in form.has_medical_needs %}
                                    <div class="form-check">
                                        {{ choice.tag }}
                                        <label class="form-check-label" for="{{ choice.id_for_label }}">
                                            {{ choice.choice_label }}
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="mb-3" id="medical-detail-container">
                            <label for="{{ form.medical_allergy_details.id_for_label }}" class="form-label">Medical/Allergy Details (non-dietary)</label>
                            {{ form.medical_allergy_details }}
                        </div>
                        
                        <!-- Photo Consent -->
                        <h4 class="text-success mt-4 mb-3">Photo Consent</h4>
                        <div class="mb-3">
                            <div class="form-check">
                                {{ form.photo_consent }}
                                <label class="form-check-label" for="{{ form.photo_consent.id_for_label }}">
                                    {{ form.photo_consent.label }}
                                </label>
                            </div>
                        </div>
                        
                        <!-- Form Errors -->
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}
                        
                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="bi bi-check-circle"></i> Register Child
                            </button>
                            <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> Back to Dashboard
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'registration/css/three_field_date_widget.css' %}">
<script>
// Three Field Date Widget JavaScript
document.addEventListener('DOMContentLoaded', function() {
    initializeThreeFieldDateWidgets();
});

function initializeThreeFieldDateWidgets() {
    const widgets = document.querySelectorAll('.three-field-date-widget');
    
    widgets.forEach(widget => {
        const fieldName = widget.dataset.fieldName;
        const dayField = widget.querySelector('.three-field-date-day');
        const monthField = widget.querySelector('.three-field-date-month');
        const yearField = widget.querySelector('.three-field-date-year');
        const hiddenField = widget.querySelector(`input[name="${fieldName}"]`);
        const errorDiv = widget.querySelector(`#${fieldName}_error`);
        
        const fields = [dayField, monthField, yearField];
        
        // Auto-advance functionality
        fields.forEach((field, index) => {
            field.addEventListener('input', function(e) {
                // Only allow numeric input
                this.value = this.value.replace(/[^0-9]/g, '');
                
                // Auto-advance when field is full
                if (this.value.length === parseInt(this.maxLength) && fields[index + 1]) {
                    fields[index + 1].focus();
                }
                
                // Run validation on every change
                validateDate(fields, hiddenField, errorDiv);
            });
            
            // Handle backspace for better UX
            field.addEventListener('keydown', function(e) {
                if (e.key === 'Backspace' && this.value === '' && index > 0) {
                    fields[index - 1].focus();
                }
            });
            
            // Handle paste events
            field.addEventListener('paste', function(e) {
                e.preventDefault();
                const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                handlePastedDate(pastedText, fields, hiddenField, errorDiv);
            });
        });
        
        // Initial validation if fields have values
        validateDate(fields, hiddenField, errorDiv);
    });
}

function validateDate(fields, hiddenField, errorDiv) {
    const [dayField, monthField, yearField] = fields;
    const day = dayField.value.trim();
    const month = monthField.value.trim();
    const year = yearField.value.trim();
    
    // Clear previous errors and reset styles
    clearErrors(fields, errorDiv);
    
    // Only validate when all fields are filled
    if (!day || !month || year.length < 4) {
        hiddenField.value = '';
        return false;
    }
    
    // Pad with zeros for validation
    const paddedDay = day.padStart(2, '0');
    const paddedMonth = month.padStart(2, '0');
    
    // Create date object for validation
    const testDate = new Date(`${year}-${paddedMonth}-${paddedDay}`);
    
    // Check if date is valid
    const isValidDate = testDate &&
        testDate.getFullYear() == year &&
        testDate.getMonth() + 1 == parseInt(month) &&
        testDate.getDate() == parseInt(day);
    
    if (!isValidDate) {
        showError(fields, errorDiv, 'Please enter a valid date of birth');
        hiddenField.value = '';
        return false;
    }
    
    // Range validation (2010-01-01 to today)
    const minDate = new Date('2010-01-01');
    const maxDate = new Date();
    maxDate.setHours(23, 59, 59, 999); // End of today
    
    if (testDate < minDate) {
        showError(fields, errorDiv, 'Date of birth cannot be before 1 January 2010');
        hiddenField.value = '';
        return false;
    }
    
    if (testDate > maxDate) {
        showError(fields, errorDiv, 'Date of birth cannot be in the future');
        hiddenField.value = '';
        return false;
    }
    
    // Success - clear errors and set hidden value
    clearErrors(fields, errorDiv);
    hiddenField.value = `${year}-${paddedMonth}-${paddedDay}`;
    return true;
}

function showError(fields, errorDiv, message) {
    fields.forEach(field => {
        field.style.borderColor = '#dc3545';
        field.classList.add('is-invalid');
    });
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    errorDiv.classList.add('d-block');
}

function clearErrors(fields, errorDiv) {
    fields.forEach(field => {
        field.style.borderColor = '';
        field.classList.remove('is-invalid');
    });
    errorDiv.textContent = '';
    errorDiv.style.display = 'none';
    errorDiv.classList.remove('d-block');
}

function handlePastedDate(pastedText, fields, hiddenField, errorDiv) {
    // Try to parse various date formats
    const [dayField, monthField, yearField] = fields;
    
    // Remove any non-digit characters and split
    const digits = pastedText.replace(/[^0-9]/g, '');
    
    if (digits.length === 8) {
        // Assume DDMMYYYY format
        const day = digits.substring(0, 2);
        const month = digits.substring(2, 4);
        const year = digits.substring(4, 8);
        
        dayField.value = day;
        monthField.value = month;
        yearField.value = year;
        
        validateDate(fields, hiddenField, errorDiv);
        return;
    }
    
    // Try to split by common separators
    const parts = pastedText.split(/[\/\-\.\s]+/);
    if (parts.length === 3) {
        // Determine if it's DD/MM/YYYY or MM/DD/YYYY or YYYY/MM/DD
        let day, month, year;
        
        if (parts[0].length === 4) {
            // YYYY-MM-DD format
            year = parts[0];
            month = parts[1];
            day = parts[2];
        } else if (parts[2].length === 4) {
            // DD/MM/YYYY or MM/DD/YYYY format
            // Assume DD/MM/YYYY for Australia
            day = parts[0];
            month = parts[1];
            year = parts[2];
        }
        
        if (day && month && year) {
            dayField.value = day;
            monthField.value = month;
            yearField.value = year;
            
            validateDate(fields, hiddenField, errorDiv);
        }
    }
}
</script>
{{ form.media }}
{% endblock %}
