{% extends 'base.html' %}

{% block title %}QR Code Scanner - Summerfest{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0"><i class="bi bi-qr-code-scan"></i> Child Check-in Scanner</h3>
                </div>
                <div class="card-body">
                    
                    <!-- Camera Scanner Section -->
                    <div class="text-center mb-4">
                        <button id="startScanBtn" class="btn btn-success btn-lg me-3">
                            <i class="bi bi-camera"></i> Start Camera Scanner
                        </button>
                        <button id="stopScanBtn" class="btn btn-secondary btn-lg" style="display: none;">
                            <i class="bi bi-stop-circle"></i> Stop Scanner
                        </button>
                    </div>
                    
                    <!-- Camera View -->
                    <div id="cameraSection" style="display: none;" class="text-center mb-4">
                        <div class="position-relative d-inline-block">
                            <div id="preview" style="width: 400px; height: 300px; border: 1px solid #ccc; border-radius: 8px;"></div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Point camera at QR code</small>
                        </div>
                    </div>
                    
                    <!-- Manual Entry Fallback -->
                    <div class="text-center mb-3">
                        <button id="toggleManualBtn" class="btn btn-outline-secondary">
                            <i class="bi bi-keyboard"></i> Enter Code Manually
                        </button>
                    </div>
                    
                    <div id="manualEntrySection" style="display: none;">
                        <form id="scanForm" method="post">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="{{ form.qr_code_data.id_for_label }}" class="form-label">QR Code Data</label>
                                {{ form.qr_code_data }}
                                <small class="form-text text-muted">
                                    Enter or paste the QR code data manually
                                </small>
                            </div>
                            
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="bi bi-check-circle"></i> Check In Child
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Scan Result Display -->
                    <div id="scanResult" class="mt-4" style="display: none;">
                        <div class="alert" id="resultAlert">
                            <div id="resultMessage"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Instructions -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> How to Use</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="bi bi-camera text-success"></i> Camera Scanner (Recommended)</h6>
                            <ol>
                                <li>Click "Start Camera Scanner"</li>
                                <li>Allow camera access when prompted</li>
                                <li>Point camera at child's QR code</li>
                                <li>QR code will be automatically scanned and processed</li>
                            </ol>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="bi bi-keyboard text-info"></i> Manual Entry (Fallback)</h6>
                            <ol>
                                <li>Click "Enter Code Manually"</li>
                                <li>Use phone QR scanner app to read code</li>
                                <li>Copy and paste the code into the text field</li>
                                <li>Click "Check In Child"</li>
                            </ol>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <strong>Note:</strong> Each child can only be checked in once per day. 
                        Camera access is required for automatic scanning.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Include QR Scanner Library -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const startScanBtn = document.getElementById('startScanBtn');
    const stopScanBtn = document.getElementById('stopScanBtn');
    const cameraSection = document.getElementById('cameraSection');
    const toggleManualBtn = document.getElementById('toggleManualBtn');
    const manualEntrySection = document.getElementById('manualEntrySection');
    const form = document.getElementById('scanForm');
    const resultDiv = document.getElementById('scanResult');
    const resultAlert = document.getElementById('resultAlert');
    const resultMessage = document.getElementById('resultMessage');
    
    let html5QrcodeScanner = null;

    // Start camera scanner
    startScanBtn.addEventListener('click', function() {
        startCameraScanner();
    });

    // Stop camera scanner
    stopScanBtn.addEventListener('click', function() {
        stopCameraScanner();
    });

    // Toggle manual entry
    toggleManualBtn.addEventListener('click', function() {
        if (manualEntrySection.style.display === 'none') {
            manualEntrySection.style.display = 'block';
            toggleManualBtn.innerHTML = '<i class="bi bi-camera"></i> Use Camera Instead';
            stopCameraScanner();
        } else {
            manualEntrySection.style.display = 'none';
            toggleManualBtn.innerHTML = '<i class="bi bi-keyboard"></i> Enter Code Manually';
        }
    });

    function startCameraScanner() {
        const config = { 
            fps: 10, 
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.333334,
            disableFlip: false
        };

        html5QrcodeScanner = new Html5QrcodeScanner(
            "preview", 
            config, 
            false
        );
        
        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        
        // Update UI
        startScanBtn.style.display = 'none';
        stopScanBtn.style.display = 'inline-block';
        cameraSection.style.display = 'block';
        manualEntrySection.style.display = 'none';
    }

    function stopCameraScanner() {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.clear().then(ignore => {
                // Scanner stopped
            }).catch(err => {
                console.log("Error stopping scanner:", err);
            });
            html5QrcodeScanner = null;
        }
        
        // Update UI
        startScanBtn.style.display = 'inline-block';
        stopScanBtn.style.display = 'none';
        cameraSection.style.display = 'none';
    }

    function onScanSuccess(decodedText, decodedResult) {
        // Stop scanning immediately after successful scan
        stopCameraScanner();
        
        // Process the scanned QR code
        processQRCode(decodedText);
    }

    function onScanFailure(error) {
        // Handle scan failure (usually just means no QR code in view)
        // Don't log every failure as it's normal
    }

    function processQRCode(qrCodeData) {
        // Create form data
        const formData = new FormData();
        formData.append('qr_code_data', qrCodeData);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        // Submit to server
        fetch('{% url "attendance_scan" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            showResult(data);
        })
        .catch(error => {
            showError('An error occurred while processing the scan');
        });
    }

    function showResult(data) {
        resultDiv.style.display = 'block';
        
        if (data.status === 'success') {
            resultAlert.className = 'alert alert-success';
            resultMessage.innerHTML = `
                <h5><i class="bi bi-check-circle"></i> Success!</h5>
                <p><strong>${data.child_name}</strong> has been checked in at ${data.time}</p>
                <p>Class: ${data.class}</p>
            `;
        } else if (data.status === 'already_checked_in') {
            resultAlert.className = 'alert alert-warning';
            resultMessage.innerHTML = `
                <h5><i class="bi bi-exclamation-triangle"></i> Already Checked In</h5>
                <p><strong>${data.child_name}</strong> is already checked in today</p>
                <p>Class: ${data.class}</p>
            `;
        } else if (data.status === 'insufficient_funds') {
            resultAlert.className = 'alert alert-danger';
            resultMessage.innerHTML = `
                <h5><i class="bi bi-credit-card"></i> Insufficient Funds</h5>
                <p><strong>${data.child_name}</strong> - ${data.message}</p>
                <p>Current balance: $${data.balance}</p>
                <p>Required: $${data.required}</p>
            `;
        } else {
            resultAlert.className = 'alert alert-danger';
            resultMessage.innerHTML = `
                <h5><i class="bi bi-x-circle"></i> Error</h5>
                <p>${data.message}</p>
            `;
        }
        
        // Auto-hide result after 5 seconds and restart scanner
        setTimeout(function() {
            resultDiv.style.display = 'none';
            if (!manualEntrySection.style.display || manualEntrySection.style.display === 'none') {
                startCameraScanner();
            }
        }, 5000);
    }

    function showError(message) {
        resultDiv.style.display = 'block';
        resultAlert.className = 'alert alert-danger';
        resultMessage.innerHTML = `
            <h5><i class="bi bi-x-circle"></i> Error</h5>
            <p>${message}</p>
        `;
    }

    // Manual form submission
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const qrInput = form.querySelector('input[name="qr_code_data"]');
            if (qrInput.value) {
                processQRCode(qrInput.value);
                qrInput.value = ''; // Clear input
            }
        });
    }
});
</script>
{% endblock %}
