{% extends 'base.html' %}

{% block title %}Teacher Dashboard - Summerfest{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container py-5">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="bi bi-people"></i> Class Management - {{ today|date:"M j, Y" }}
            </h2>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Children in Your Classes</h4>
                    <div>
                        <a href="{% url 'attendance_scan' %}" class="btn btn-primary me-2">
                            <i class="bi bi-qr-code-scan"></i> Scan QR Codes
                        </a>
                        <a href="{% url 'manual_sign_in' %}" class="btn btn-outline-primary">
                            <i class="bi bi-pencil-square"></i> Manual Sign-in
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if children_data %}
                        <!-- Filter by class -->
                        <div class="mb-3">
                            <label for="classFilter" class="form-label">Filter by Class:</label>
                            <select id="classFilter" class="form-select" style="width: auto; display: inline-block;">
                                <option value="" {% if not selected_class %}selected{% endif %}>All Classes</option>
                                <option value="creche" {% if selected_class == 'creche' %}selected{% endif %}>Creche (0-2yrs)</option>
                                <option value="tackers" {% if selected_class == 'tackers' %}selected{% endif %}>Little Tackers (3yrs-Kindy)</option>
                                <option value="minis" {% if selected_class == 'minis' %}selected{% endif %}>Minis (Years 1-2)</option>
                                <option value="nitro" {% if selected_class == 'nitro' %}selected{% endif %}>Nitro (Years 3-4)</option>
                                <option value="56ers" {% if selected_class == '56ers' %}selected{% endif %}>56ers (Years 5-6)</option>
                            </select>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th style="width: 80px;">Class</th>
                                        <th style="width: 90px;">Status</th>
                                        <th style="width: 80px;">Times</th>
                                        <th style="width: 60px;">Photo</th>
                                        <th>Emergency Contact</th>
                                        <th>Medical/Dietary</th>
                                        <th style="width: 120px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for data in children_data %}
                                        <tr class="child-row" data-class="{{ data.child.child_class }}">
                                            <td>
                                                <strong>{{ data.child.first_name }} {{ data.child.last_name }}</strong><br>
                                                <small class="text-muted">DOB: {{ data.child.date_of_birth|date:"M j, Y" }}</small>
                                            </td>
                                            <td style="width: 80px;">
                                                <small style="line-height: 1.2;">{{ data.child.get_child_class_display }}</small>
                                            </td>
                                            <td style="width: 90px;">
                                                {% if data.attendance %}
                                                    <span class="badge" style="background-color: {{ data.attendance.get_status_color }}; font-size: 10px;">
                                                        {{ data.attendance.get_status_display }}
                                                    </span>
                                                {% else %}
                                                    <span class="badge" style="background-color: #6c757d; font-size: 10px;">Not yet arrived</span>
                                                {% endif %}
                                            </td>
                                            <td style="width: 80px;">
                                                {% if data.attendance %}
                                                    <small>{{ data.attendance.time_in|time:"H:i" }}</small>
                                                    {% if data.attendance.time_out %}
                                                        <br><small>Out: {{ data.attendance.time_out|time:"H:i" }}</small>
                                                    {% endif %}
                                                {% else %}
                                                    <small class="text-muted">-</small>
                                                {% endif %}
                                            </td>
                                            <td style="width: 60px; text-align: center;">
                                                {% if data.child.photo_consent %}
                                                    <span class="badge bg-success" title="Photo consent given"><i class="bi bi-camera"></i></span>
                                                {% else %}
                                                    <span class="badge bg-danger" title="No photo consent"><i class="bi bi-camera-fill"></i></span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <strong>{{ data.child.parent.emergency_contact_name }}</strong><br>
                                                <small>{{ data.child.parent.emergency_contact_phone }}</small><br>
                                                <small class="text-muted">{{ data.child.parent.get_emergency_contact_relationship_display }}</small>
                                            </td>
                                            <td>
                                                {% if data.child.has_dietary_needs %}
                                                    <div class="alert alert-warning py-1 mb-1">
                                                        <small><strong>Dietary:</strong> {{ data.child.dietary_needs_detail }}</small>
                                                    </div>
                                                {% endif %}
                                                {% if data.child.has_medical_needs %}
                                                    <div class="alert alert-danger py-1 mb-1">
                                                        <small><strong>Medical:</strong> {{ data.child.medical_allergy_details }}</small>
                                                    </div>
                                                {% endif %}
                                                {% if not data.child.has_dietary_needs and not data.child.has_medical_needs %}
                                                    <small class="text-muted">None reported</small>
                                                {% endif %}
                                            </td>
                                            <td style="width: 120px;">
                                                <div class="btn-group-vertical" role="group" style="width: 100%;">
                                                    {% if not data.attendance %}
                                                        <!-- Not yet arrived - allow check-in -->
                                                        <button class="btn btn-success btn-sm mb-1" 
                                                                onclick="manualCheckIn({{ data.child.id }}, '{{ data.child.first_name }} {{ data.child.last_name }}')">
                                                            <i class="bi bi-box-arrow-in-right"></i> Check In
                                                        </button>
                                                    {% elif data.attendance.status == 'checked_in' %}
                                                        <!-- Checked in - allow to go to class -->
                                                        <button class="btn btn-primary btn-sm mb-1" 
                                                                onclick="changeStatus({{ data.child.id }}, 'in_class', '{{ data.child.first_name }} {{ data.child.last_name }}')">
                                                            <i class="bi bi-book"></i> In Class
                                                        </button>
                                                    {% elif data.attendance.status == 'in_class' %}
                                                        <!-- In class - allow pickup -->
                                                        <button class="btn btn-warning btn-sm mb-1" 
                                                                onclick="changeStatus({{ data.child.id }}, 'picked_up', '{{ data.child.first_name }} {{ data.child.last_name }}')">
                                                            <i class="bi bi-person-check"></i> Picked Up
                                                        </button>
                                                    {% elif data.attendance.status == 'picked_up' %}
                                                        <!-- Already picked up -->
                                                        <span class="badge bg-purple text-white">Complete</span>
                                                    {% endif %}
                                                    
                                                    <!-- QR Code button -->
                                                    <a href="{% url 'child_qr_code' data.child.id %}" class="btn btn-outline-info btn-sm" 
                                                       title="View QR Code" target="_blank" style="font-size: 10px;">
                                                        <i class="bi bi-qr-code"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Summary Stats -->
                        <div class="row mt-4">
                            <div class="col-md-4">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h5>Present Today</h5>
                                        <h2 id="presentCount">0</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-warning text-dark">
                                    <div class="card-body text-center">
                                        <h5>Not Checked In</h5>
                                        <h2 id="notCheckedInCount">0</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-secondary text-white">
                                    <div class="card-body text-center">
                                        <h5>Checked Out</h5>
                                        <h2 id="checkedOutCount">0</h2>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-people" style="font-size: 4rem; color: #ccc;"></i>
                            <h5 class="mt-3">No children registered yet</h5>
                            <p class="text-muted">Children will appear here once parents complete their registration.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const classFilter = document.getElementById('classFilter');
    const childRows = document.querySelectorAll('.child-row');
    
    // Filter functionality
    if (classFilter) {
        classFilter.addEventListener('change', function() {
            const selectedClass = this.value;
            
            // Redirect to the same page with class filter parameter
            const url = new URL(window.location);
            if (selectedClass) {
                url.searchParams.set('class', selectedClass);
            } else {
                url.searchParams.delete('class');
            }
            window.location.href = url.toString();
        });
    }
    
    // Update summary counts based on current data
    function updateCounts() {
        let presentCount = 0;
        let notCheckedInCount = 0;
        let checkedOutCount = 0;
        
        // Count all visible rows (server-side filtering means all rows are relevant)
        childRows.forEach(row => {
            const statusBadge = row.querySelector('td:nth-child(3) .badge');
            if (statusBadge) {
                const statusText = statusBadge.textContent.trim();
                if (statusText === 'Checked in' || statusText === 'In class') {
                    presentCount++;
                } else if (statusText === 'Not yet arrived') {
                    notCheckedInCount++;
                } else if (statusText === 'Picked up') {
                    checkedOutCount++;
                }
            }
        });
        
        document.getElementById('presentCount').textContent = presentCount;
        document.getElementById('notCheckedInCount').textContent = notCheckedInCount;
        document.getElementById('checkedOutCount').textContent = checkedOutCount;
    }
    
    // Initial count update
    updateCounts();
});

// Manual check-in function
function manualCheckIn(childId, childName) {
    if (confirm(`Check in ${childName}?`)) {
        fetch(`/manual_checkin/${childId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Reload page while preserving the current filter
                reloadWithFilter();
            } else if (data.status === 'payment_required') {
                alert(`Payment Required: ${data.message}\n\nCurrent Balance: ${data.current_balance}\nRequired: ${data.required_charge}\nShortfall: ${data.shortfall}`);
            } else {
                alert(data.message || 'An error occurred');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while checking in the child.');
        });
    }
}

// Status change function
function changeStatus(childId, newStatus, childName) {
    const statusNames = {
        'in_class': 'In Class',
        'picked_up': 'Picked Up'
    };
    
    if (confirm(`Change ${childName} status to ${statusNames[newStatus]}?`)) {
        fetch(`/change_status/${childId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({status: newStatus})
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Reload page while preserving the current filter
                reloadWithFilter();
            } else {
                alert(data.message || 'An error occurred');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating status.');
        });
    }
}

// Function to reload page while preserving filter
function reloadWithFilter() {
    // Simply reload - the current URL parameters will be preserved
    location.reload();
}

// Function to get current filter parameter for redirects
function getCurrentFilter() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('class') || '';
}
</script>
{% endblock %}
